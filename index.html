<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cleveland and McGill's</title>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <style>
        #agree {
            height: 800px;
            width: 800px;
            margin-top:10%;
            margin-bottom:0;
            margin-left:auto;
            margin-right:auto;
        }

        p {
            width: 80%;
            margin: auto;
            font: 25px/1.5 Helvetica, sans-serif;
        }

        #agree_button{height:20px; position:relative; margin: -20px -50px; width:100px; top:50%; left:50%;}

        #disagree_button
        {
            height:20px; position:relative; margin: -20px -50px; width:100px; top:50%; left:70%;
        }

    </style>
    <script>
        var participant_ID="participant_"+Math.floor(Math.random()*999999);
        var count=1;
        var trails=[];
        var trueValue;
        var reportedValue;
        var visType;
        var svg;
        var vis=["ver_bar","pie_chart","tree_map"];


        window.onload = function() {
            //y
            var agree_button = document.getElementById("agree_button");
            agree_button.addEventListener('click',remove_ele);
        };


        //function to remove elements from DOM
        function remove_ele() {
            var element = document.getElementById("agree");
            element.parentNode.removeChild(element);
            page_load();

        }

        //function to create 10 random data points between 0-100,min=0 and max=100
        function getRandomSet(min, max) {
            var count=0;
            var dataset=[];
            while(count<10){
                value= Math.floor(Math.random() * (max - min + 1)) + min;
                if(dataset.indexOf(value)===-1){
                   dataset.push(value);
                    count++;
                }

            }
            return dataset;
        }

        //function to select a random point within the dataset
        //length parameter corresponds to length of dataset
        function getRandomPoint(length) {
            var value=0;
            value= Math.floor(Math.random() * (length+1));
            return value;
        }

        //function to calculate the error
        function errorestimator(truePercent,reportedValue){

            var diff=Math.abs(truePercent-reportedValue);
            if(diff===0)
                return 0;
            else
                return Math.log2(diff+1/8);
        }

        //function to create a pie chart
        function  pieChart(svg){

            var border=2;
            var bordercolor='black';
            var radius = 200;
            var dataset=getRandomSet(0,100);

            var chart=svg.data([dataset])
                    .append("svg:g")
                    .attr("transform", "translate(" + radius + "," + radius + ")") ;

            console.log(svg.data(dataset));

            var arc = d3.svg.arc() // draw arc of given radius
                    .outerRadius(radius);

            var pie = d3.layout.pie() // assign data for pie chart
                    .value(function(d) { return d; });

            var arcs = chart.selectAll("g.slice") // slice the circle
                    .data(pie)
                    .enter()
                    .append("svg:g")
                    .attr("class", "slice");

            console.log("error");

            arcs.append("svg:path")
                    .style("stroke", bordercolor)
                    .style("fill", "none")
                    .style("stroke-width", border)
                    .attr("d", arc);

            arc = d3.svg.arc().innerRadius(0).outerRadius(radius);
            var centers = pie(dataset).map(arc.centroid);

        //plotting 2 random points
            var count=0;
            var points=[];
            var value;
            while(count<2){
                value=getRandomPoint(9);
                if(points.indexOf(value)===-1){
                    points.push(value);
                    count++;
                }

            }

            chart.selectAll("dot")
                    .data(points)
                    .enter().append("circle")
                    .attr("r", 4)
                    .attr("cx", function(d){
                        return centers[d][0];
                    })
                    .attr("cy", function(d){
                        return centers[d][1];
                    });

            if(dataset[points[0]]>dataset[points[1]])
                trueValue= dataset[points[1]]/dataset[points[0]] * 100;
            else
                trueValue= dataset[points[0]]/dataset[points[1]] * 100;

        }



        //function to add stacked graph
        function create_stackgraph(w,h){

            var data;
            var data_parsed;
            var dataset=getRandomSet(0,100);
            data=dataset.map(function (d) {
                return [d];

                });
            data_parsed=data.map(function (d) {
                return d.map(function (p,i) {
                    return {x:i,y:p,y0:0};


                });

            });

            var border=2;
            var bordercolor='black';
            var margin = {
                top: 20,
                bottom: 30,
                left: 25,
                right: 40
            };
            var width = w -margin.left-margin.right;
            var height = h-margin.top-margin.bottom;

            var x = d3.scale.ordinal().rangeRoundBands([0, width], .05);
            x.domain(dataset.map(function(d,i) { return i }));

            var stack=d3.layout.stack();
            var layers=stack(data_parsed);
            var y = d3.scale.linear().range([height, 0]);
            var yStackMax = d3.max(layers, function(layer) {return d3.max(layer, function(d) { return d.y0 + d.y; }); });
            y.domain([0, yStackMax]);


            var xAxis = d3.svg.axis()
                    .scale(x)
                    .tickFormat("")
                    .orient("bottom");

            var yAxis = d3.svg.axis()
                    .scale(y)
                    .tickFormat("")
                    .orient("left");
            console.log(stack(data_parsed));

            svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

            svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);

            svg.selectAll(".rect")
                    .data(stack(data_parsed))
                    .enter()
                    .append("rect")
                    .attr("x", width/2)
                    .attr("y",function (d) {
                        return y(d[0].y0 + d[0].y);


                    })
                    .attr("width",200)
                    .attr("height",function (d) {
                       return y(d[0].y0) - y(d[0].y0 + d[0].y);

                    })
                    .style("stroke", bordercolor)
                    .style("fill", "none")
                    .style("stroke-width", border);

            //plotting 2 random points
            var count=0;
            var points=[];
            var value;
            while(count<2){
                value=getRandomPoint(9);
                if(points.indexOf(value)===-1){
                    points.push(value);
                    count++;
                }

            }

            svg.selectAll("dot")
                    .data(points)
                    .enter().append("circle")
                    .attr("r", 4)
                    .attr("cx", function(d) { return  width/2+100;})
                    .attr("cy", function(d) { return y(getRandomPoint(data_parsed[d][0].y0+data_parsed[d][0].y)); });

            //returning the true value
            if(points[0]>points[1])
                trueValue= points[1]/points[0]*100;
            else
                trueValue= points[0]/points[1]*100;

        }



        //function to add a bar chart
        function create_barchart(svg,w,h){

            var dataset=getRandomSet(0,100);
            var border=2;
            var bordercolor='black';
            var margin = {
                top: 20,
                bottom: 30,
                left: 25,
                right: 40
            };
            var width = w -margin.left-margin.right;
            var height = h-margin.top-margin.bottom;

            var x = d3.scale.ordinal().rangeRoundBands([0, width], .05);
            var y = d3.scale.linear().range([height, 0]);
            x.domain(dataset.map(function(d,i) { return i }));
            y.domain([0,100]);

            var xAxis = d3.svg.axis()
                    .scale(x)
                    .tickFormat("")
                    .orient("bottom");
            var yAxis = d3.svg.axis()
                    .scale(y)
                    .tickFormat("")
                    .orient("left");


            svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

            svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);



            svg.selectAll(".rect")
                    .data(dataset)
                    .enter()
                    .append("rect")
                    .attr("x",function(d,i) { return x(i);})
                    .attr("y",function (d) {
                        return  y(d);


                    })
                    .attr("width",x.rangeBand())
                    .attr("height",function (d) {
                        return height - y(d);

                    })
                    .style("stroke", bordercolor)
                    .style("fill", "none")
                    .style("stroke-width", border);

            //plotting 2 random points
            var count=0;
            var points=[];
            var value;
            while(count<2){
                value=getRandomPoint(9);
                if(points.indexOf(value)===-1){
                    points.push(value);
                    count++;
                }

            }

            svg.selectAll("dot")
                    .data(points)
                    .enter().append("circle")
                    .attr("r", 4)
                    .attr("cx", function(d) { return (x(d)+x.rangeBand()/2); })
                    .attr("cy", function(d) { return y(getRandomPoint(dataset[d])); });

            //returning the true value
            if(points[0]>points[1])
                trueValue= points[1]/points[0]*100;
            else
                trueValue= points[0]/points[1]*100;
        }

        //function to create the svg canvas
        function create_svg(w,h){
            var w = w;
            var h = h;
            var margin = {
                top: 20,
                bottom: 30,
                left: 25,
                right: 40
            };
            var width = w -margin.left-margin.right;
            var height = h-margin.top-margin.bottom;
            var svg = d3.select("body")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform",
                            "translate(" + margin.left + "," + margin.top + ")");
            return svg;

        }


        function push_trail(){
            reportedValue=document.getElementById("reportedValue").value;
            var error=errorestimator(trueValue,reportedValue);
            var report={
                vis:visType,
                true:trueValue,
                report:reportedValue,
                error:error

            };
            trails.push(report);
        }



        //function to send the file to server
        function send_file(){
            //sending the data to server
            var file="";
            i=0;

            while(i<60){
                file+=file+participant_ID+','+trails[i].vis+','+trails[i].true+','+trails[i].report+','+trails[i].error;
            }

            var xmlhttp;

            if (window.XMLHttpRequest)
                xmlhttp=new XMLHttpRequest();
                else
                xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");

            xmlhttp.onreadystatechange=function(){};
            xmlhttp.open("POST","csvUpdate.php",true);
            xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
            xmlhttp.send("file="+file+'&'+'ID='+participant_ID);

        }

        function  update_chart() {
            //remove elements of the svg
        svg.selectAll("*").remove();
            push_trail();
            console.log(trails);
            document.getElementById("reportedValue").value="";

        count++;
            if(count<60){
                visType=vis[count%3];
                switch (visType){
                    case vis[0]:create_barchart(svg,960,600);
                        break;
                    case vis[1]:pieChart(svg);
                        break;
                    case vis[2]:create_stackgraph(960,600);
                        break;

                }


            }



        }





        function page_load(){
            svg=create_svg(960,600);
            create_barchart(svg,960,600);
            visType=vis[0];
            document.getElementById("instructions").innerHTML="Two values are marked with dots.<br>What percentage do you think the smaller value is of the larger value?<br>Please type <u>just the number</u> in below.<br><br>(i.e. if you think the smaller one is exactly half of the larger one, type in 50)<br><br><input id='reportedValue' type='tel' placeholder='Enter value here'><input type='button' onclick='update_chart();' value='Next'>";

        }

    </script>
</head>
<body id="body">
<div id="agree">
    <p>
        Do you want to see how well your accuracy in reading charts?.
    </p>
    <p>
        You can do that by answering 10 questions regarding the percentage of every smaller value to a larger value based on different charts shown.
    </p>
    <p>
        If you agree to do so, your answers will be recorded so that at the end you will be able to see how close your answers to the actual percentages.
    </p>

    <button id="agree_button"type="button">Agree</button>
    <button id="disagree_button" type="button">Disagree</button>
</div>
<p id='instructions'></p>
</body>
</html>